import streamlit as st\nimport fastf1 as ff1\nimport pandas as pd\nimport numpy as np\nimport plotly.express as px\nimport os\n\nst.set_page_config(layout="wide", page_title="F1 Telemetry Dashboard")\n\nst.title("F1 Telemetry Dashboard (fastf1)")\n\n# Cache fastf1 data to disk for faster repeated loads\ncache_dir = os.path.expanduser('~/.cache/fastf1')\nff1.Cache.enable_cache(cache_dir)\n\nwith st.sidebar:\n    st.header("Session selector")\n    year = st.number_input("Year", min_value=2010, max_value=2100, value=2024, step=1)\n    event = st.text_input("Event name (as used by fastf1 API)", value="Monaco")\n    session_type = st.selectbox("Session", options=["P", "Q", "R"], index=2)\n    driver_code = st.text_input("Driver code (e.g. VER, LEC, HAM)", value="VER")\n    load_btn = st.button("Load session")\n\n@st.cache_data(show_spinner=False)\ndef load_session_cached(year, event, session_type):\n    session = ff1.get_session(year, event, session_type)\n    session.load()  # will cache automatically\n    return session\n\ndef clean_telemetry(telemetry: pd.DataFrame) -> pd.DataFrame:\n    df = telemetry.copy()\n    if 'Time' in df.columns:\n        try:\n            df['Time'] = pd.to_datetime(df['Time'])\n            df = df.set_index('Time')\n        except Exception:\n            pass\n    numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()\n    for col in df.columns:\n        if col not in numeric_cols:\n            try:\n                df[col] = pd.to_numeric(df[col], errors='ignore')\n            except Exception:\n                pass\n    numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()\n    if numeric_cols:\n        df[numeric_cols] = df[numeric_cols].interpolate(method='linear', limit_direction='both')\n        df[numeric_cols] = df[numeric_cols].fillna(method='ffill').fillna(method='bfill')\n    df = df[~df.index.duplicated(keep='first')]\n    df = df.drop_duplicates()\n    return df\n\ndef detect_pit_stops(driver_laps: pd.DataFrame) -> pd.DataFrame:\n    cols = [c for c in ['PitInTime','PitOutTime','PitDuration','PitIn','PitOut'] if c in driver_laps.columns]\n    if cols:\n        pits = driver_laps[driver_laps[cols].notna().any(axis=1)][['Driver','LapNumber'] + cols]\n        return pits\n    else:\n        return pd.DataFrame()\n\nif load_btn:\n    try:\n        with st.spinner("Loading session... this may take a bit on first run"):\n            session = load_session_cached(year, event, session_type)\n        st.success(f"Loaded session: {session.event_name} - {session.name}")\n        laps = session.laps\n\n        # pick driver laps robustly\n        try:\n            driver_laps = laps.pick_drivers([driver_code])\n        except Exception:\n            driver_laps = laps[laps['Driver'] == driver_code]\n\n        if driver_laps.empty:\n            st.error(f"No laps found for driver {driver_code}. Available drivers: {sorted(laps['Driver'].unique().tolist())}")\n        else:\n            st.subheader(f"Driver: {driver_code} â€” Laps overview")\n            # Show lap table\n            lap_cols = [c for c in ['LapNumber', 'LapTime', 'Stint', 'Compound', 'PitInTime','PitOutTime','PitDuration'] if c in driver_laps.columns]\n            st.dataframe(driver_laps[lap_cols].reset_index(drop=True), height=250)\n\n            # Pick fastest lap telemetry\n            fastest = driver_laps.pick_fastest()\n            telemetry = fastest.get_telemetry()\n            telemetry_clean = clean_telemetry(telemetry)\n\n            st.subheader("Fastest lap telemetry (cleaned)")\n            st.write(f"Telemetry points: {telemetry_clean.shape[0]}")\n\n            # Telemetry plots in two columns\n            c1, c2 = st.columns(2)\n            with c1:\n                if 'Speed' in telemetry_clean.columns and 'Distance' in telemetry_clean.columns:\n                    fig = px.line(telemetry_clean.reset_index(), x='Distance', y='Speed', title='Speed vs Distance')\n                    st.plotly_chart(fig, use_container_width=True)\n                elif 'Speed' in telemetry_clean.columns:\n                    fig = px.line(telemetry_clean.reset_index(), y='Speed', title='Speed (index vs value)')\n                    st.plotly_chart(fig, use_container_width=True)\n                else:\n                    st.info("No Speed column available in telemetry.")\n\n                # Throttle / Brake\n                cols_tb = [c for c in ['Throttle','Brake'] if c in telemetry_clean.columns]\n                if cols_tb:\n                    fig2 = px.line(telemetry_clean.reset_index(), x='Distance' if 'Distance' in telemetry_clean.columns else telemetry_clean.reset_index().columns[0], y=cols_tb, title='Throttle / Brake')\n                    st.plotly_chart(fig2, use_container_width=True)\n\n            with c2:\n                if 'nGear' in telemetry_clean.columns:\n                    figg = px.line(telemetry_clean.reset_index(), x='Distance' if 'Distance' in telemetry_clean.columns else telemetry_clean.reset_index().columns[0], y='nGear', title='Gear')\n                    st.plotly_chart(figg, use_container_width=True)\n\n                # Some telemetry availability notes\n                st.markdown("**Telemetry columns available:**")\n                st.write(list(telemetry_clean.columns))\n\n            # Pit stop detection\n            pits = detect_pit_stops(driver_laps)\n            st.subheader("Pit stops")\n            if pits.empty:\n                st.warning("No explicit pit stop records found in session.laps for this driver.")\n                st.info("You can inspect lap table above to infer pit laps or use timing discontinuities to reconstruct pits.")\n            else:\n                st.dataframe(pits.reset_index(drop=True))\n\n            # Download cleaned telemetry\n            csv = telemetry_clean.reset_index().to_csv(index=False).encode('utf-8')\n            st.download_button(label="Download cleaned telemetry (CSV)", data=csv, file_name=f"{year}_{event}_{session_type}_{driver_code}_telemetry.csv", mime='text/csv')\n\n    except Exception as e:\n        st.error(f"Error while loading session: {e}")\n        st.exception(e)\nelse:\n    st.info("Pick session parameters in the sidebar and click 'Load session'.")\n